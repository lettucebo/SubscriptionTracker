name: Release

on:
  push:
    tags:
      - '*'  # Trigger on any tag
  workflow_dispatch:


jobs:
  build-and-deploy:
    name: Build and Deploy Applications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # Setup .NET for backend build
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # Setup Node.js for frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'src/subscription-tracker-client/package-lock.json'

      # Build backend
      - name: Build backend
        run: |
          dotnet restore src/SubscriptionTracker.sln
          dotnet build src/SubscriptionTracker.sln --configuration Release --no-restore
          dotnet publish src/SubscriptionTracker.Api/SubscriptionTracker.Api.csproj -c Release -o ./publish/api

      # Build frontend
      - name: Build frontend
        env:
          API_URL: ${{ vars.API_URL }}
        run: |
          cd src/subscription-tracker-client
          # Replace baseUrl in config.js with API_URL
          cat > src/config.js << EOF
          export const config = {
            baseUrl: "${API_URL}"
          }
          EOF
          npm ci
          npm run build

      # Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Set environment variables
      - name: Set environment variables
        id: set_variables
        run: |
          echo "RESOURCE_GROUP=SubTracker" >> $GITHUB_OUTPUT
          echo "WEBAPP_NAME=subtracker-app" >> $GITHUB_OUTPUT
          echo "STATIC_WEBAPP_NAME=subtracker-stapp" >> $GITHUB_OUTPUT

      # Deploy backend to Azure Web App
      - name: Deploy backend to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.set_variables.outputs.WEBAPP_NAME }}
          package: ./publish/api

      # Get Static Web App deployment token
      - name: Get Static Web App deployment token
        id: get_swa_token
        run: |
          DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
            --name ${{ steps.set_variables.outputs.STATIC_WEBAPP_NAME }} \
            --resource-group ${{ steps.set_variables.outputs.RESOURCE_GROUP }} \
            --query properties.apiKey -o tsv)
          echo "::add-mask::$DEPLOYMENT_TOKEN"
          echo "DEPLOYMENT_TOKEN=$DEPLOYMENT_TOKEN" >> $GITHUB_ENV

      # Deploy frontend to Azure Static Web App
      - name: Deploy frontend to Static Web App
        id: deploy_swa
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ env.DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "src/subscription-tracker-client/dist"
          skip_app_build: true
          output_location: ""
          api_location: ""

      # Post-deployment verification
      - name: Post-deployment verification
        run: |
          echo "Deployment completed successfully!"
          echo "Version deployed: ${{ steps.get_version.outputs.VERSION }}"
          echo "Backend deployed to: ${{ steps.set_variables.outputs.WEBAPP_NAME }}"
          echo "Frontend deployed to: ${{ steps.set_variables.outputs.STATIC_WEBAPP_NAME }}"
